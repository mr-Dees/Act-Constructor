<!-- templates/constructor.html -->
{% extends "base.html" %}

{% block content %}
<!-- –®–∞–≥ 1: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∞–∫—Ç–∞ -->
<div id="step1" class="step-content">
    <div class="panels">
        <!-- –ü–∞–Ω–µ–ª—å –¥–µ—Ä–µ–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
        {% include "components/tree_panel.html" %}

        <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
        {% include "components/preview_panel.html" %}
    </div>
</div>

<!-- –®–∞–≥ 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
<div id="step2" class="step-content hidden">
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–∫—Ç–∞ -->
    <div id="itemsContainer" class="items-container"></div>

    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div class="step-actions">
        <button id="backBtn" class="btn btn-secondary">‚óÑ –ù–∞–∑–∞–¥</button>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î -->
        <button id="saveToDbBtn" class="btn btn-primary" style="margin-right:8px;">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
        </button>

        <!-- –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–æ–≤ -->
        <div class="save-button-group">
            <button id="generateBtn" class="btn btn-success save-main-btn">
                –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã
            </button>
            <button id="formatDropdownBtn"
                    class="btn btn-success save-dropdown-btn"
                    title="–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞"
                    aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞"
                    aria-expanded="false">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round"/>
                </svg>
            </button>

            <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
            <div id="formatMenu" class="format-dropdown-menu hidden" role="menu">
                <label class="format-option">
                    <input type="checkbox" value="txt" checked>
                    <span>–¢–µ–∫—Å—Ç (TXT)</span>
                </label>
                <label class="format-option">
                    <input type="checkbox" value="md">
                    <span>Markdown (MD)</span>
                </label>
                <label class="format-option">
                    <input type="checkbox" value="docx">
                    <span>Word (DOCX)</span>
                </label>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î"
        document.getElementById('saveToDbBtn')?.addEventListener('click', async () => {
            console.log('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î"');

            if (!window.currentActId) {
                console.warn('currentActId –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                Notifications.warning('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç');
                return;
            }

            console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç ID:', window.currentActId);

            try {
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ DOM –≤ AppState
                if (typeof ItemsRenderer !== 'undefined') {
                    console.log('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ DOM...');
                    ItemsRenderer.syncDataToState();
                }

                console.log('–í—ã–∑–æ–≤ APIClient.saveActContent...');
                await APIClient.saveActContent(window.currentActId);
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
            }
        });
    });
</script>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é -->
{% include "components/context_menu.html" %}
{% endblock %}
