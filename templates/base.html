<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Конструктор актов{% endblock %}</title>

    <!-- Основные стили -->
    <link rel="stylesheet" href="/static/css/main.css">

    <!-- Дополнительные стили страницы -->
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Шапка приложения -->
    {% include 'header/header.html' %}

    <!-- Основной контент страницы -->
    {% block content %}{% endblock %}

    <!-- Конфигурация приложения -->
    <script src="/static/js/app-config.js"></script>

    <!-- Авторизация (должна загружаться первой) -->
    <script src="/static/js/auth.js"></script>

    <script>
        // Проверка авторизации только при открытии акта (constructor)
        (async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const actId = urlParams.get('act_id');

            // Если это страница конструктора — требуем свежую авторизацию из окружения
            if (actId && window.location.pathname === '/constructor') {
                const isAuthorized = await AuthManager.requireAuth();
                if (!isAuthorized) {
                    throw new Error('Unauthorized');
                }
            }
        })();
    </script>

    <!-- Базовые утилиты -->
    <script src="/static/js/notifications.js"></script>
    <script src="/static/js/storage-manager.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/navigation-manager.js"></script>
    <script src="/static/js/format-menu-manager.js"></script>
    <script src="/static/js/settings-menu.js"></script>

    <!-- Диалоговая система -->
    <script src="/static/js/dialog/dialog-base.js"></script>
    <script src="/static/js/dialog/dialog-confirm.js"></script>
    <script src="/static/js/dialog/dialog-create-act.js"></script>
    <script src="/static/js/dialog/dialog-help.js"></script>

    <!-- Контекстное меню -->
    <script src="/static/js/context-menu/context-menu-core.js"></script>
    <script src="/static/js/context-menu/context-menu-tree.js"></script>
    <script src="/static/js/context-menu/context-menu-cells.js"></script>
    <script src="/static/js/context-menu/context-menu-violation.js"></script>
    <script src="/static/js/context-menu/context-menu-links-footnotes.js"></script>

    <!-- Управление состоянием -->
    <script src="/static/js/state/state-core.js"></script>
    <script src="/static/js/state/state-tree.js"></script>
    <script src="/static/js/state/state-content.js"></script>

    <!-- Дерево структуры -->
    <script src="/static/js/tree/tree-drag-drop.js"></script>
    <script src="/static/js/tree/tree-renderer.js"></script>
    <script src="/static/js/tree/tree-core.js"></script>
    <script src="/static/js/tree/tree-utils.js"></script>

    <!-- Элементы документа -->
    <script src="/static/js/items/items-title-editing.js"></script>
    <script src="/static/js/items/items-renderer.js"></script>

    <!-- Таблицы -->
    <script src="/static/js/table/table-cells-operations.js"></script>
    <script src="/static/js/table/table-sizes.js"></script>
    <script src="/static/js/table/table-core.js"></script>

    <!-- Предпросмотр -->
    <script src="/static/js/preview/preview.js"></script>
    <script src="/static/js/preview/preview-table-renderer.js"></script>
    <script src="/static/js/preview/preview-textblock-renderer.js"></script>
    <script src="/static/js/preview/preview-violation-renderer.js"></script>

    <!-- Текстовые блоки -->
    <script src="/static/js/textblock/textblock-core.js"></script>
    <script src="/static/js/textblock/textblock-editor.js"></script>
    <script src="/static/js/textblock/textblock-formatting.js"></script>
    <script src="/static/js/textblock/textblock-toolbar.js"></script>
    <script src="/static/js/textblock/textblock-links-footnotes.js"></script>

    <!-- Нарушения -->
    <script src="/static/js/violation/violation-core.js"></script>
    <script src="/static/js/violation/violation-paste.js"></script>
    <script src="/static/js/violation/violation-additional-content.js"></script>
    <script src="/static/js/violation/violation-rendering.js"></script>
    <script src="/static/js/violation/violation-drag-drop.js"></script>
    <script src="/static/js/violation/violation-file-upload.js"></script>
    <script src="/static/js/violation/violation-init.js"></script>

    <!-- Модули валидации -->
    <script src="/static/js/validation/validation.js"></script>
    <script src="/static/js/validation/validation-act.js"></script>
    <script src="/static/js/validation/validation-core.js"></script>
    <script src="/static/js/validation/validation-table.js"></script>
    <script src="/static/js/validation/validation-tree.js"></script>

    <script src="/static/js/acts-menu.js"></script>

    <!-- Информация подсказок -->
    {% include 'header/help/step1.html' %}
    {% include 'header/help/step2.html' %}

    <!-- Шаблон для меню актов -->
    {% include 'header/acts_menu_item.html' %}
    {% include 'components/acts/create_act_dialog.html' %}
    {% include 'components/acts/team_member_row.html' %}
    {% include 'components/acts/directive_row.html' %}
    {% include 'components/acts/acts_loading.html' %}
    {% include 'components/acts/acts_empty_state.html' %}
    {% include 'components/acts/acts_error_state.html' %}

    <!-- Шаблон ошибки авторизации -->
    {% include 'components/auth_error.html' %}

    <!-- Дополнительные скрипты страницы -->
    {% block extra_js %}{% endblock %}
</body>
</html>
